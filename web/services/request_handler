<?php

namespace CougarTutorial;

use Cougar\Security\Security;
use Cougar\Cache\CacheFactory;
use Cougar\PDO\PDO;
use Cougar\RestService\AnnotatedRestService;
use CougarTutorial\Security\DbBasicAuthenticationProvider;

// Initialize the application
require_once(__DIR__ . "/../../init.php");

// Create a new Security context (required by Model Factory and Rest Service)
$security = new Security();

// Create the AnnotatedWebService object to handle handle incoming REST requests
$service = new AnnotatedRestService($security);

// Create the application cache object
$cache = CacheFactory::getApplicationCache();

// Create the database connection
$pdo = new PDO("sqlite:" . __DIR__ . "/../../db/cougar_tutorial.db");

// Create the Model factory
$model_factory = new ModelFactory($security, $cache, $pdo);

// Create User object
$user = new User($security);

// Create the State object
$state = new State($security, $model_factory);

// Create the basic authentication provider and add it to the security object
$authentication_provider =
    new DbBasicAuthenticationProvider($service, $model_factory->UserPdo());
$security->addAuthenticationProvider($authentication_provider);

// Tell the service object to bind web services from our User and State objects
$service->bindFromObject($user);
$service->bindFromObject($state);

// Handle the request
$service->handleRequest();
?>
